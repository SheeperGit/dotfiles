#!/bin/sh

#####################################
# Open images based on filter query #
#####################################

# Usage: 
#   feh-filter [awk-pattern] [img-dir]
# 
# Description: 
#   Opens images in feh based on a user-provided awk-style pattern. 
#
#   If a directory is not provided, the user is prompted to select 
#   a directory from BASE_DIR (excluding those mentioned in EXCLUDE).
#
#   It is expected that the directory contains images and text files 
#   with the same names. (e.g., filename1.png, filename1.txt, etc.)
#
# Examples:  
#   feh-filter '/blue eyes/ && /red hair/'  # Finds all images tagged with 'blue eyes' and 'red hair'.
#   feh-filter '!/blue eyes/ || /red hair/'  # Finds all images not tagged with 'blue eyes' or tagged with 'red hair'.
#
#   See awk(1) for full documentation on the available query patterns.

# dmenu appearance
alias dmenu="dmenu -m \"0\" -fn \"monospace:size=18\" -nb \"#222222\" -nf \"#bbbbbb\" -sb \"#003a4e\" -sf \"#eeeeee\""

alias feh='feh --fullscreen -S name --version-sort'

# Directory of LoRA training directories. #
BASE_DIR="$HOME/programs/grabber/training"

# Directories to exclude from BASE_DIR. #
EXCLUDE='out'

# Get the last argument of the script. (i.e., the image directory) #
last_arg() {
  last=""
  for arg in "$@"; do
    last="$arg"
  done

  echo "$last"
}

if [ $# -gt 1 ] ; then
  last=$(last_arg "$@")
  img_dir=$(realpath "$last")
  [ ! -d "$img_dir" ] && {
    printf "Invalid directory: %s" "$img_dir" >&2
    exit 1
  }
fi

# Select the directory to browse images from. #
[ -z "$img_dir" ] && {
  img_dir=$(
    find "$BASE_DIR" -mindepth 1 -type d | \
    grep -v -E "$BASE_DIR/($EXCLUDE)" | \
    sed "s#$BASE_DIR/##" | \
    dmenu -i -p "Select a Directory:"
  ) || exit 1
  img_dir="$BASE_DIR/$img_dir"
}

[ -z "$img_dir" ] && {
  notify-send "üñºÔ∏è No image files found in $img_dir"
  exit 1
}


# Get all txt files within selected dir #
txts=$(find "$img_dir" -maxdepth 5 -type f -name "*.txt")
[ -z "$txts" ] && {
  notify-send "‡ºº ‡ºé‡∫∂ ‡∑¥ ‡ºé‡∫∂‡ºΩ No text files found in $img_dir"
  exit 1
}

# Get all images with matching filter query #
imgs="$(
  awk "$1 {print FILENAME}" $txts | \
  sed -e 's#.*/\([^/]*\)\.[^.]*$#\1#' | \
  while read -r filename; do
    find "$img_dir" -type f -regex ".*/$filename\.\(jpg\|jpeg\|png\|webp\)$"
  done
)"

feh $imgs

